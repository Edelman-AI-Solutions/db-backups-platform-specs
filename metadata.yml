title: Simon Willison's Weblog, in Datasette
source: simonwillison.net
source_url: https://simonwillison.net/
about: simonw/simonwillisonblog-backup
about_url: https://github.com/simonw/simonwillisonblog-backup
plugins:
  datasette-faiss:
    tables:
    - ["simonwillisonblog", "blog_entry_embeddings"]
databases:
  simonwillisonblog:
    queries:
      embedding_search:
        sql: |-
          select
            value,
            json_object(
              'label',
              blog_entry.title,
              'href',
              'https://simonwillison.net/e/' || blog_entry.id
            ) as title,
            substr(blog_entry.body, 0, 500)
          from
            json_each(
              faiss_search(
                'simonwillisonblog',
                'blog_entry_embeddings',
                (
                  select
                    openai_embedding(:query, :_cookie_openai_api_key)
                ),
                10
              )
            )
            join blog_entry on value = blog_entry.id
      answer_question:
        sql: |-
          with query as (
            select
              openai_embedding(:question, :_cookie_openai_api_key) as q
          ),
          top_n as (
            select
              value
            from json_each(
              faiss_search(
                'simonwillisonblog',
                'blog_entry_embeddings',
                (select q from query),
                5
              )
            )
          ),
          texts as (
            select 'Created: ' || created || ', Title: ' || title || 
            ', Body: ' || openai_strip_tags(body) as text
            from blog_entry where id in (select value from top_n)
          ),
          prompt as (
            select openai_build_prompt(text, 'Context:
          ------------
          ', '
          ------------
          Given the above context, answer the following question: ' || :question,
            case when cast(:length as integer) = 0 then 256 else cast(:length as integer) end,
            4000 - openai_count_tokens(:question)
            ) as prompt from texts
          )
          select
            'Response' as title,
            openai_davinci(
              prompt,
              case when cast(:length as integer) = 0 then 256 else cast(:length as integer) end,
              0.7,
              :_cookie_openai_api_key
            ) as value
          from prompt
          union all
          select
            'Prompt' as title,
            prompt from prompt
