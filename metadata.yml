title: Simon Willison's Weblog, in Datasette
source: simonwillison.net
source_url: https://simonwillison.net/
about: simonw/simonwillisonblog-backup
about_url: https://github.com/simonw/simonwillisonblog-backup
plugins:
  datasette-faiss:
    tables:
    - ["simonwillisonblog", "blog_entry_embeddings"]
databases:
  simonwillisonblog:
    queries:
      embedding_search:
        sql: |-
          select
            value,
            json_object(
              'label',
              blog_entry.title,
              'href',
              'https://simonwillison.net/e/' || blog_entry.id
            ) as title,
            substr(blog_entry.body, 0, 500)
          from
            json_each(
              faiss_search(
                'simonwillisonblog',
                'blog_entry_embeddings',
                (
                  select
                    openai_embedding(:query, :_cookie_openai_api_key)
                ),
                10
              )
            )
            join blog_entry on value = blog_entry.id
      answer_question:
        sql: |-
          with query as (
            select
              openai_embedding(:query, :_cookie_openai_api_key) as q
          ),
          top_n as (
            select
              value
            from json_each(
              faiss_search(
                'simonwillisonblog',
                'blog_entry_embeddings',
                (select q from query),
                5
              )
            )
          ),
          content as (
            select
              blog_entry.id,
              blog_entry.title,
              substr(blog_entry.body, 0, 3000) as content
            from
              blog_entry
            where
              blog_entry.id in (select value from top_n)
          )
          select openai_davinci(group_concat(content, ' ') || '
          ----
          Given the above content, answer the following question: ' || :query, 256, 0.7, :_cookie_openai_api_key)
          as response from content
